version: "3.9"


services:

  database:
    image: mariadb:10.5
    container_name: "${APP_NAME}_database"
    restart: unless-stopped
    env_file: .env
    # Open port only for the host. Need for SSH tunnel to connect to database from SQL Manager like HeidiSQL
    # Uncomment ports directive for using SSH tunnel, and uncomment SSH_TUNNEL_EXT_PORT var in .env file
    #ports:
    #  - 127.0.0.1:${SSH_TUNNEL_EXT_PORT}:3306
    volumes:
      - ./db-data:/var/lib/mysql

  wordpress:
    build: ./docker/wordpress
    container_name: "${APP_NAME}_wordpress"
    restart: unless-stopped
    depends_on:
      - database
    env_file: .env
    volumes:
      - ./wp-core:/var/www/html # wordpress root folder for development only
      #- wordpress_core:/var/www/html # wordpress root folder volume for production
      - ./wp-content:/var/www/html/wp-content # all needed wp-content folders, uploads should be in .gitignore
      # Debug log
      - ./logs/wordpress:/var/log/wordpress
      # Cron
      #- ./config/crontabs:/etc/crontabs
      #- ./logs/cron:/var/log/cron

  nginx:
    build: ./docker/nginx
    container_name: "${APP_NAME}_nginx"
    restart: unless-stopped
    depends_on:
      - database
      - wordpress
    env_file: .env
    volumes:
      - ./config/nginx/templates:/etc/nginx/templates
      - ./config/nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
      - ./wp-core:/var/www/html # wordpress root folder for development only
      #- wordpress_core:/var/www/html # wordpress root folder volume for production
      - ./wp-content:/var/www/html/wp-content # all needed wp-content folders, uploads should be in .gitignore

  redis:
    image: redis:6.2-alpine
    container_name: "${APP_NAME}_redis"
    restart: unless-stopped
    
  cron:
    build: ./docker/cron
    container_name: "${APP_NAME}_cron"
    restart: unless-stopped
    env_file: .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/crontabs:/etc/crontabs
#      - "${PWD}/config-samples/config.sample.mapping.json:/opt/crontab/config.json:rw"

#volumes:
  #wordpress_core: