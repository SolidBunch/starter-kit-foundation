version: "3.9"


services:

  database:
    build: ./images/database
    restart: unless-stopped
    env_file: .env
    environment:
      # should be .env files for all environments
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_ROOT_USER: ${MYSQL_ROOT_USER}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql

  wordpress:
    build: ./images/wordpress
    restart: unless-stopped
    links:
      - database
    depends_on:
      - database
    env_file: .env
    environment:
      WORDPRESS_DB_HOST: ${MYSQL_HOST}
      WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
      WORDPRESS_DB_USER: ${MYSQL_USER}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
      WORDPRESS_DEBUG: ${WP_DEBUG}
      WORDPRESS_CONFIG_EXTRA: |

          define( 'WP_SITEURL', '${WP_SITEURL}' );
          define( 'WP_HOME', '${WP_HOME}' );

          define( 'WP_MEMORY_LIMIT', '${WP_MEMORY_LIMIT}' );
          define( 'WP_MAX_MEMORY_LIMIT', '${WP_MAX_MEMORY_LIMIT}' );

          define( 'WP_ENVIRONMENT_TYPE', '${WP_ENVIRONMENT_TYPE}' );

          define( 'WP_DEBUG_DISPLAY', !!'${WP_DEBUG_DISPLAY}' );
          define( 'WP_DEBUG_LOG', '${WP_DEBUG_LOG}' );

          //Cron
          define( 'DISABLE_WP_CRON', true );

          //Redis
          define( 'WP_REDIS_HOST', '${WP_REDIS_HOST}' );
          define( 'WP_REDIS_PORT', ${WP_REDIS_PORT} );
          define( 'WP_CACHE_KEY_SALT', '${WP_CACHE_KEY_SALT}' );
          // automatically delete cache keys after 7 days
          // define( 'WP_REDIS_MAXTTL', ${WP_REDIS_MAXTTL} );

    volumes:
      - ./web/wordpress-core:/var/www/html # wordpress root folder for development only
      #- wordpress_core:/var/www/html # wordpress root folder volume for production
      - ./web/app:/var/www/html/wp-content # all needed wp-content folders, uploads should be in .gitignore
      - ./logs/wordpress:/var/log/wordpress
      # cron
      - ./config/crontabs:/etc/crontabs
      - ./logs/cron:/var/log/cron
      # backups folder
      - ./backup:/srv/rsync/backup

  nginx:
    image: nginx:1.20-alpine
    restart: unless-stopped
    links:
      - wordpress
    depends_on:
      - database
      - wordpress
    env_file: .env
    environment:
      NGINX_HOST: ${APP_DOMAIN}
      NGINX_PORT: ${APP_PORT}
    command: /bin/sh -c "envsubst '$$NGINX_HOST, $$NGINX_PORT' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    volumes:
      - ./config/nginx:/etc/nginx/conf.d
      - ./logs/nginx:/var/log/nginx
      - ./web/wordpress-core:/var/www/html # wordpress root folder for development only
      #- wordpress_core:/var/www/html # wordpress root folder volume for production
      - ./web/app:/var/www/html/wp-content # all needed wp-content folders, uploads should be in .gitignore

  redis:
    image: redis:6.2-alpine
    restart: unless-stopped

volumes:
  db_data:
  #wordpress_core: